document.addEventListener("DOMContentLoaded", function () {
    const listaBilleteras = document.getElementById("listaBilleteras");
    const usuarioSpan = document.querySelector(".textWhite strong"); // Capturar el elemento donde va el nombre
    const logoutBtn = document.querySelector(".logout"); // Capturar el bot√≥n de cerrar sesi√≥n
    const API_URL_BILLETERAS = "http://localhost:5000/api/wallets"; // Endpoint de billeteras

    // **Obtener el nombre del usuario desde el token**
    function mostrarNombreUsuario() {
        const token = localStorage.getItem("token");

        if (token) {
            try {
                const payload = JSON.parse(atob(token.split(".")[1])); // Decodificar JWT
                console.log("üîç Datos del usuario:", payload);
                usuarioSpan.textContent = payload.nombre.toUpperCase(); // Mostrar el nombre en la navbar
            } catch (error) {
                console.error("‚ùå Error al decodificar el token:", error);
                usuarioSpan.textContent = "USUARIO"; // Si hay error, dejar el texto por defecto
            }
        } else {
            console.warn("‚ö†Ô∏è No se encontr√≥ un token en localStorage");
            usuarioSpan.textContent = "USUARIO";
        }
    }

    // **Obtener la caja seleccionada (Caja 1 o Caja 2)**
    function obtenerCajaSeleccionada() {
        const caja = localStorage.getItem("cajaSeleccionada");
        console.log("üìå Caja seleccionada:", caja);
        return caja || "Caja 1"; // Si no hay valor, por defecto "Caja 1"
    }

    // **Cargar billeteras filtradas por caja**
    async function cargarBilleteras() {
        const cajaSeleccionada = localStorage.getItem("cajaSeleccionada") || "Caja 1"; // Recupera la caja guardada
    
        console.log("üìå Caja seleccionada al cargar billeteras:", cajaSeleccionada);
    
        try {
            const response = await fetch(API_URL_BILLETERAS);
            const billeteras = await response.json();
            listaBilleteras.innerHTML = ""; // Limpiar lista antes de actualizar
    
            // Filtrar billeteras seg√∫n la caja seleccionada
            const billeterasFiltradas = billeteras.filter(billetera => billetera.caja === cajaSeleccionada);
    
            if (billeterasFiltradas.length === 0) {
                listaBilleteras.innerHTML = `<li>No hay billeteras en ${cajaSeleccionada}.</li>`;
            } else {
                billeterasFiltradas.forEach(billetera => {
                    let li = document.createElement("li");
                    li.innerHTML = `<strong>${billetera.nombre}:</strong> $${billetera.saldo.toFixed(2)}`;
                    listaBilleteras.appendChild(li);
                });
            }
        } catch (error) {
            console.error("‚ùå Error al cargar billeteras:", error);
            listaBilleteras.innerHTML = `<li>Error al cargar billeteras.</li>`;
        }
    }
    
    

    // **Cerrar sesi√≥n (Eliminar token y caja seleccionada)**
    logoutBtn.addEventListener("click", function (event) {
        event.preventDefault();
        console.log("üîç Click en CERRAR SESI√ìN");

        Swal.fire({
            title: "¬øCerrar sesi√≥n?",
            text: "Se eliminar√° la sesi√≥n y ser√°s redirigido a la p√°gina de inicio.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "S√≠, salir",
            cancelButtonText: "Cancelar"
        }).then((result) => {
            if (result.isConfirmed) {
                console.log("‚úÖ Confirmaci√≥n recibida, eliminando token...");
                localStorage.removeItem("token"); // Eliminar el token del localStorage
                localStorage.removeItem("cajaSeleccionada"); // Eliminar caja seleccionada
                window.location.href = "index.html"; // Redirigir a index.html
            }
        });
    });

    // **Ejecutar funciones al cargar la p√°gina**
    mostrarNombreUsuario();
    cargarBilleteras();
});
