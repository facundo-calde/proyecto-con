document.addEventListener("DOMContentLoaded", function () {
  const listaBilleteras = document.getElementById("listaBilleteras");
  const usuarioSpan = document.querySelector(".textWhite strong"); // Capturar el elemento donde va el nombre
  const logoutBtn = document.querySelector(".logout"); // Capturar el bot√≥n de cerrar sesi√≥n
  const API_URL_BILLETERAS = "http://localhost:5000/api/wallets"; // Endpoint de billeteras

  // **Obtener el nombre del usuario desde el token**
  function mostrarNombreUsuario() {
    const token = localStorage.getItem("token");

    if (token) {
      try {
        const payload = JSON.parse(atob(token.split(".")[1])); // Decodificar JWT
        console.log("üîç Datos del usuario:", payload);
        usuarioSpan.textContent = payload.nombre.toUpperCase(); // Mostrar el nombre en la navbar
      } catch (error) {
        console.error("‚ùå Error al decodificar el token:", error);
        usuarioSpan.textContent = "USUARIO"; // Si hay error, dejar el texto por defecto
      }
    } else {
      console.warn("‚ö†Ô∏è No se encontr√≥ un token en localStorage");
      usuarioSpan.textContent = "USUARIO";
    }
  }

  // **Obtener la billeteras
  async function cargarBilleteras() {
    const puestoSeleccionado = localStorage.getItem("puestoSeleccionado"); // ID del job
    console.log("üìå Puesto seleccionado al cargar billeteras:", puestoSeleccionado);

    try {
      const token = localStorage.getItem("token");

      const response = await fetch(API_URL_BILLETERAS, {
        headers: {
          "Authorization": `Bearer ${token}`
        }
      });

      const billeteras = await response.json();
      listaBilleteras.innerHTML = ""; // Limpiar lista antes de actualizar

      // Filtrar billeteras seg√∫n el job seleccionado
      // OJO: Si tu endpoint devuelva `billetera.caja` como un objeto (por populate),
      // haz: billetera.caja._id === puestoSeleccionado
      const billeterasFiltradas = billeteras.filter(billetera => {
        return billetera.caja === puestoSeleccionado;
        // o billetera.caja._id === puestoSeleccionado si populaste
      });

      if (billeterasFiltradas.length === 0) {
        listaBilleteras.innerHTML = `<p>No hay billeteras para este puesto.</p>`;
      } else {
        billeterasFiltradas.forEach(billetera => {
          let div = document.createElement("div");
          div.classList.add("billetera-card");

          div.innerHTML = `
                <strong>${billetera.nombre}</strong>
                <span>$${billetera.saldo.toFixed(2)}</span>
              `;
          listaBilleteras.appendChild(div);
        });
      }
    } catch (error) {
      console.error("‚ùå Error al cargar billeteras:", error);
      listaBilleteras.innerHTML = `<p>Error al cargar billeteras.</p>`;
    }
  }





  // **Cerrar sesi√≥n (Eliminar token y caja seleccionada)**
  logoutBtn.addEventListener("click", function (event) {
    event.preventDefault();
    console.log("üîç Click en CERRAR SESI√ìN");

    Swal.fire({
      title: "¬øCerrar sesi√≥n?",
      text: "Se eliminar√° la sesi√≥n y ser√°s redirigido a la p√°gina de inicio.",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "S√≠, salir",
      cancelButtonText: "Cancelar"
    }).then((result) => {
      if (result.isConfirmed) {
        console.log("‚úÖ Confirmaci√≥n recibida, eliminando token...");
        localStorage.removeItem("token"); // Eliminar el token del localStorage
        localStorage.removeItem("cajaSeleccionada"); // Eliminar caja seleccionada
        window.location.href = "index.html"; // Redirigir a index.html
      }
    });
  });

  // **Ejecutar funciones al cargar la p√°gina**
  mostrarNombreUsuario();
  cargarBilleteras();
});

document.addEventListener("DOMContentLoaded", async function () {
  // Obtener el ID del puesto seleccionado del localStorage
  const puestoSeleccionado = localStorage.getItem("puestoSeleccionado");
  if (!puestoSeleccionado) {
    console.warn("No se encontr√≥ un puesto seleccionado");
    return;
  }

  try {
    // Obtener el job por ID
    const response = await fetch(`http://localhost:5000/api/jobs/${puestoSeleccionado}`);
    if (!response.ok) {
      const errorData = await response.json();
      console.error("Error al obtener el puesto:", errorData);
      return;
    }

    const job = await response.json();
    // Suponiendo que en el modelo se utiliza 'fichas' para la cantidad de fichas
    const cantidadFichas = job.fichas || 0;
    // Formatear el n√∫mero con separador de miles
    const formattedFichas = cantidadFichas.toLocaleString("es-ES");

    // Actualizar el contenido del elemento
    document.getElementById("cantidadFichas").textContent = formattedFichas;
  } catch (error) {
    console.error("Error en la solicitud:", error);
  }
});

// URL de tus endpoints (ajusta seg√∫n corresponda)
const API_URL_DEPOSITOS = "http://localhost:5000/api/depositos";
const API_URL_GASTOS = "http://localhost:5000/api/gastos";

// Asumamos que el primer enlace "‚ûï Agregar" es para dep√≥sitos sin reclamar 
const addLinks = document.querySelectorAll("a.add");

// --- Dep√≥sitos sin reclamar ---
addLinks[0].addEventListener("click", async (e) => {
  e.preventDefault();

  const { value: monto } = await Swal.fire({
    title: "Agregar Dep√≥sito sin reclamar",
    html: `<input type="number" id="swal-deposito-monto" class="swal2-input" placeholder="Monto">`,
    focusConfirm: false,
    preConfirm: () => {
      const inputMonto = document.getElementById("swal-deposito-monto").value;
      const monto = parseFloat(inputMonto);
      if (!monto || monto <= 0) {
        Swal.showValidationMessage("Ingresa un monto v√°lido");
      }
      return monto;
    }
  });

  if (monto) {
    // Preparar datos a enviar
    const data = { monto, fecha: new Date() };

    // Obtener token del localStorage
    const token = localStorage.getItem("token");

    try {
      const response = await fetch(API_URL_DEPOSITOS, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`  // Agregar token aqu√≠
        },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        Swal.fire("√âxito", "Dep√≥sito agregado correctamente", "success");
        // Actualizar interfaz si es necesario
      } else {
        Swal.fire("Error", "No se pudo agregar el dep√≥sito", "error");
      }
    } catch (error) {
      console.error("Error en la solicitud:", error);
      Swal.fire("Error", "Error en la solicitud", "error");
    }
  }
});

// --- Gastos de oficina ---
addLinks[1].addEventListener("click", async (e) => {
  e.preventDefault();

  const { value: formValues } = await Swal.fire({
    title: "Agregar Gasto de Oficina",
    html:
      `<input type="number" id="swal-gasto-monto" class="swal2-input" placeholder="Monto">` +
      `<input type="text" id="swal-gasto-descripcion" class="swal2-input" placeholder="Descripci√≥n">`,
    focusConfirm: false,
    preConfirm: () => {
      const inputMonto = document.getElementById("swal-gasto-monto").value;
      const descripcion = document.getElementById("swal-gasto-descripcion").value.trim();
      const monto = parseFloat(inputMonto);

      if (!monto || monto <= 0) {
        Swal.showValidationMessage("Ingresa un monto v√°lido");
      }
      if (!descripcion) {
        Swal.showValidationMessage("Ingresa una descripci√≥n");
      }
      return { monto, descripcion };
    }
  });

  if (formValues) {
    // Preparar datos a enviar
    const data = {
      monto: formValues.monto,
      descripcion: formValues.descripcion,
      fecha: new Date()
    };

    // Obtener token del localStorage
    const token = localStorage.getItem("token");

    try {
      const response = await fetch(API_URL_GASTOS, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}` // Agregar token aqu√≠
        },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        Swal.fire("√âxito", "Gasto agregado correctamente", "success");
        // Actualizar la interfaz si es necesario
      } else {
        Swal.fire("Error", "No se pudo agregar el gasto", "error");
      }
    } catch (error) {
      console.error("Error en la solicitud:", error);
      Swal.fire("Error", "Error en la solicitud", "error");
    }
  }
});

// --- Propinas ---
addLinks[4].addEventListener("click", async (e) => {
  e.preventDefault();

  const { value: formValues } = await Swal.fire({
    title: "Agregar Propina",
    html:
      `<input type="number" id="swal-propina-monto" class="swal2-input" placeholder="Monto">` +
      `<input type="text" id="swal-propina-descripcion" class="swal2-input" placeholder="Descripci√≥n (opcional)">`,
    focusConfirm: false,
    preConfirm: () => {
      const inputMonto = document.getElementById("swal-propina-monto").value;
      const descripcion = document.getElementById("swal-propina-descripcion").value.trim();
      const monto = parseFloat(inputMonto);

      if (!monto || monto <= 0) {
        Swal.showValidationMessage("Ingresa un monto v√°lido");
      }

      return { monto, descripcion };
    }
  });

  if (formValues) {
    const data = {
      monto: formValues.monto,
      descripcion: formValues.descripcion,
      fecha: new Date()
    };

    const token = localStorage.getItem("token");

    try {
      const response = await fetch("http://localhost:5000/api/propinas", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        Swal.fire("√âxito", "Propina agregada correctamente", "success");
      } else {
        Swal.fire("Error", "No se pudo agregar la propina", "error");
      }
    } catch (error) {
      console.error("Error al agregar propina:", error);
      Swal.fire("Error", "Error en la solicitud", "error");
    }
  }
});

// Movimiento de fichas (index confirmado = 2)
addLinks[2].addEventListener("click", async (e) => {
  e.preventDefault();
  console.log("üü° Click en Agregar Movimiento de fichas");

  const token = localStorage.getItem("token");
  const jobId = localStorage.getItem("puestoSeleccionado");

  if (!token || !jobId) {
    console.warn("‚ùå Faltan token o puestoSeleccionado");
    return;
  }

  try {
    const res = await fetch("http://localhost:5000/api/wallets", {
      headers: {
        "Authorization": `Bearer ${token}`
      }
    });

    const billeteras = (await res.json()).filter(b => b.caja === jobId);

    if (!billeteras.length) {
      return Swal.fire("Atenci√≥n", "No hay billeteras disponibles para este puesto", "info");
    }

    const billeteraOptions = billeteras.map(b => `<option value="${b._id}">${b.nombre}</option>`).join("");

    const { value: formValues } = await Swal.fire({
      title: "Agregar Movimiento de Fichas",
      html:
        `<select id="swal-wallet-id" class="swal2-input">${billeteraOptions}</select>` +
        `<input type="number" id="swal-monto" class="swal2-input" placeholder="Monto">` +
        `<input type="text" id="swal-descripcion" class="swal2-input" placeholder="Descripci√≥n">`,
      focusConfirm: false,
      preConfirm: () => {
        const walletId = document.getElementById("swal-wallet-id").value;
        const monto = parseFloat(document.getElementById("swal-monto").value);
        const descripcion = document.getElementById("swal-descripcion").value.trim();

        if (!walletId || isNaN(monto)) {
          Swal.showValidationMessage("Seleccion√° billetera y monto v√°lido");
        }

        return { walletId, monto, descripcion };
      }
    });

    if (formValues) {
      const data = {
        walletId: formValues.walletId,
        monto: formValues.monto,
        descripcion: formValues.descripcion,
        jobId
      };

      const response = await fetch("http://localhost:5000/api/movimientos", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      if (response.ok) {
        Swal.fire("√âxito", "Movimiento registrado correctamente", "success");
      } else {
        const errorData = await response.json();
        Swal.fire("Error", errorData.error || "Error al guardar", "error");
      }
    }

  } catch (error) {
    console.error("‚ùå Error al cargar movimiento:", error);
    Swal.fire("Error", "No se pudo abrir el formulario", "error");
  }
});
